# AGENTS.md - Massage Therapy Coach Context

## 1. Project Overview
This project is a **mobile-first web app** designed to guide users through massage sessions. The core experience is "glanceable" and "audio-first", meaning the user can follow along without constantly looking at the screen, but can easily check their progress or the current step when needed.

**Primary Goal**: Enable users to explore gestures, run guided flows (sequences of gestures), and build custom flows.

## 2. Architecture & Tech Stack

### Frontend
- **Framework**: React 19 + Vite + TypeScript
- **Styling**: Tailwind CSS v4 (using `@theme` and CSS variables, oklch colors)
- **Components**: `shadcn/ui` (Radix primitives) + custom components
- **Animation**: Framer Motion (layoutId shared transitions, Reorder drag, AnimatePresence pages)
- **State Management**: Zustand with `persist` middleware
- **Routing**: `react-router-dom` v7 with React.lazy code-splitting
- **Search**: Fuse.js weighted fuzzy search
- **PWA**: vite-plugin-pwa with Workbox service worker

### Content Pipeline (Local-First)
- **Source of Truth**: `src/content/gestures/<id>/gesture.json` & `src/content/flows/<id>/flow.json`
- **Runtime Access**: `src/content/generated/index.ts` (generated by `pnpm content:scan`). Exports `allGestures`, `allFlows`, `gestureMap`.
- **Media**: Co-located in gesture folders (audio.mp3, video.mp4, poster.webp, captions.vtt)

### Persistence
- **Storage**: `localStorage` via Zustand `persist` middleware
- **Data**: User flows (CRUD), favorites, session resume snapshots, reduced motion preference

## 3. Key Constraints & Guidelines

### UX / UI
- **Glanceability is King**: Massive typography for countdowns, minimal distractions
- **Audio-First**: App usable with screen off; clear audio cues (Start, Halfway, Switch Side)
- **Motion**: `layoutId` for shared element transitions. All motion respects `useReducedMotion`.
- **Safety**: Contraindication warnings shown before play. Pre-session safety check dialog for flows with contraindications.

### Code Style
- **Functional Components**: React Hooks
- **Strict TypeScript**: No `any`. Interfaces for all data structures
- **Colocation**: Feature-specific code in `src/features/<feature>`
- **Atomic Design**: Shared UI atoms in `src/components/ui`

## 4. Workflows

### Adding a New Gesture
1. Run `pnpm content:new-gesture`
2. Fill out the prompt (Name, Body Area, etc.)
3. Populate the generated `gesture.json` in `src/content/gestures/<slug>`
4. Add media files (`audio.mp3`, `video.mp4`, `poster.webp`, optionally `captions.vtt`)
5. Run `pnpm content:validate` to check integrity
6. Run `pnpm content:scan` to regenerate the runtime index

### Building a Feature
1. Check `docs/PRD/specs/*.md` for specific requirements
2. Check `docs/PRD/tasks/milestone-*.md` for the current milestone
3. Implement the feature in `src/features/<feature>`
4. Run `pnpm build` to verify TypeScript + Vite build passes
5. Update milestone PRDs to reflect completion

## 5. Directory Structure
```
src/
├── app/              # App shell: layout with bottom nav + settings drawer
├── features/         # Feature-specific domains
│   ├── gestures/     # GestureList, GestureDetail, TranscriptSection
│   ├── flows/        # FlowList (tabbed curated/user), FlowDetail
│   ├── builder/      # BuilderHome, FlowEditor, GesturePicker
│   └── player/       # PlayerView, card stack, CaptionOverlay, audio chainer, wake lock
├── components/       # SafetyCheckDialog, SettingsDrawer
├── components/ui/    # shadcn/ui components
├── lib/              # Utilities, hooks, stores, types
│   ├── stores/       # player.ts, user-data.ts, user-flows.ts, session-resume.ts
│   ├── hooks/        # use-reduced-motion.ts
│   ├── types/        # gesture.ts, flow.ts, player.ts
│   └── utils/        # utils.ts (cn), parse-vtt.ts
├── content/          # Content source (committed to repo)
│   ├── gestures/     # 12 gestures with JSON + media placeholders
│   ├── flows/        # 4 curated flows
│   └── generated/    # Runtime index (auto-generated)
└── motion/           # tokens.ts (springs, durations) + primitives.tsx
```

## 6. Active Context (Current Status)

### Milestones
- **M1 Foundation**: COMPLETE — Repo scaffold, 12 gestures + 4 flows, content pipeline, types, gesture library, player MVP, motion tokens, app shell, shadcn
- **M2 Player Polish**: COMPLETE — Card stack (Prev/Current/Next), ProgressOverview, glance mode, wake lock, FlowDetail, flow favorites
- **M3 Media & Resume**: MOSTLY COMPLETE — Audio chaining engine, video overlay + lazy loading, session resume snapshots + restore. Remaining: captions display when VTT content exists (UI built, awaiting content)
- **M4 Flow Builder**: COMPLETE — User flows CRUD store, BuilderHome, FlowEditor with drag-to-reorder, GesturePicker sheet, per-step config, preview, auto-save indicator, user flows in FlowList
- **M5 Polish**: MOSTLY COMPLETE — Safety warnings + pre-session check, reduced motion, ARIA labels, Fuse.js search, extended filters/sort, lazy routes, PWA, settings drawer with disclaimers, high contrast support, production build verified

### Remaining Items
- **3.2.3-3.2.4**: Caption display + transcript view UI is built, waiting for VTT content files
- **5.4.1**: Performance audit on real device (code-level optimizations done)
- **5.5.3**: Deploy to hosting (configured for GitHub Pages, awaiting push)
- **Content**: All 12 gesture media files are 0-byte placeholders — need real audio/video/poster assets

### Key Files by Owner
| Area | Files |
|------|-------|
| Player engine | `src/features/player/PlayerView.tsx`, `CurrentStepCard.tsx`, card components, `hooks/use-audio-chainer.ts`, `CaptionOverlay.tsx` |
| Player store | `src/lib/stores/player.ts` |
| Content pipeline | `scripts/new-gesture.ts`, `scan-content.ts`, `validate-content.ts` |
| Types | `src/lib/types/gesture.ts`, `flow.ts`, `player.ts` |
| App shell | `src/app/layout.tsx`, `src/App.tsx` |
| Motion system | `src/motion/tokens.ts`, `src/motion/primitives.tsx` |
| User data | `src/lib/stores/user-data.ts`, `src/lib/stores/user-flows.ts`, `src/lib/stores/session-resume.ts` |
| Gestures UI | `src/features/gestures/GestureList.tsx`, `GestureDetail.tsx`, `TranscriptSection.tsx` |
| Flows UI | `src/features/flows/FlowList.tsx`, `FlowDetail.tsx` |
| Builder | `src/features/builder/BuilderHome.tsx`, `FlowEditor.tsx`, `GesturePicker.tsx` |
| Safety | `src/components/SafetyCheckDialog.tsx` |
| Settings | `src/components/SettingsDrawer.tsx` |
| VTT parser | `src/lib/utils/parse-vtt.ts` |
